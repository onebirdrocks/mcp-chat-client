(()=>{var a={};a.id=177,a.ids=[177],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1291:(a,b,c)=>{"use strict";c.d(b,{J:()=>h});var d=c(6690),e=c(9985);class f{constructor(){this.secretKey=process.env.ENCRYPTION_KEY||this.generateDefaultKey(),process.env.ENCRYPTION_KEY||console.warn("ENCRYPTION_KEY not set in environment. Using generated key. This is not secure for production!")}encrypt(a){try{if(!a)return"";return d.AES.encrypt(a,this.secretKey).toString()}catch(a){throw console.error("Encryption failed:",a),new e.PO("Failed to encrypt data")}}decrypt(a){try{if(!a)return"";let b=d.AES.decrypt(a,this.secretKey).toString(d.enc.Utf8);if(!b)throw Error("Failed to decrypt data - invalid key or corrupted data");return b}catch(a){throw console.error("Decryption failed:",a),new e.PO("Failed to decrypt data")}}hash(a){try{return d.SHA256(a).toString()}catch(a){throw console.error("Hashing failed:",a),new e.PO("Failed to hash data")}}generateSecureKey(){return d.lib.WordArray.random(32).toString()}maskApiKey(a){if(!a||a.length<8)return"••••";let b=Math.min(8,Math.max(0,a.length-4));return"•".repeat(b)+a.slice(-4)}isEncrypted(a){try{return this.decrypt(a),!0}catch{return!1}}generateDefaultKey(){let a=process.platform+process.arch+(process.env.HOME||process.env.USERPROFILE||"default");return d.SHA256(a+"mcp-chat-ui-default-key").toString()}}let g=null;function h(){return g||(g=new f),g}},1986:(a,b,c)=>{"use strict";c.d(b,{cQ:()=>j});var d=c(9021),e=c(3873),f=c(1291),g=c(9985);class h{constructor(a="./data/settings"){this.encryptionService=(0,f.J)(),this.settingsDir=a,this.settingsFile=e.join(a,"settings.json"),this.settings=this.getDefaultSettings()}async initialize(){try{await this.ensureSettingsDirectory(),await this.loadSettings()}catch(a){throw console.error("Failed to initialize SecureSettingsManager:",a),new g.PO("Failed to initialize settings storage")}}async getSettings(){let a={...this.settings};return a.llmProviders=a.llmProviders.map(a=>({...a,apiKey:this.encryptionService.maskApiKey(a.apiKey?this.encryptionService.decrypt(a.apiKey):"")})),a}async updateSettings(a){try{if(a.llmProviders){let b=[];for(let c of a.llmProviders){let a=this.settings.llmProviders.find(a=>a.id===c.id),d="",e="";c.apiKey&&(c.apiKey.includes("*")||c.apiKey.includes("•")?a&&(d=a.apiKey,e=a.apiKeyHash||""):(d=this.encryptionService.encrypt(c.apiKey),e=this.encryptionService.hash(c.apiKey))),b.push({...c,apiKey:d,apiKeyHash:e})}this.settings.llmProviders=b}return a.mcpServers&&(this.settings.mcpServers=a.mcpServers),a.preferences&&(this.settings.preferences={...this.settings.preferences,...a.preferences}),await this.saveSettings(),this.getSettings()}catch(a){throw console.error("Failed to update settings:",a),new g.PO("Failed to update settings")}}async getDecryptedApiKey(a){let b=this.settings.llmProviders.find(b=>b.id===a);if(!b||!b.apiKey)throw new g.yI(`API key not found for provider: ${a}`);try{return this.encryptionService.decrypt(b.apiKey)}catch(b){throw console.error(`Failed to decrypt API key for provider ${a}:`,b),new g.PO("Failed to decrypt API key")}}async validateApiKey(a,b,c){if(!b||b.length<10)return!1;switch(a){case"openai":case"deepseek":return b.startsWith("sk-")&&b.length>20;case"openrouter":return b.startsWith("sk-or-")&&b.length>30;default:return b.length>10}}async exportSettings(){return{version:"1.0.0",exportDate:new Date().toISOString(),settings:{preferences:this.settings.preferences,mcpServers:this.settings.mcpServers.map(a=>({...a,env:a.env?this.sanitizeEnvironmentVariables(a.env):void 0}))}}}async importSettings(a){try{if("1.0.0"!==a.version)throw new g.yI("Unsupported settings export version");await this.updateSettings({preferences:a.settings.preferences,mcpServers:a.settings.mcpServers})}catch(a){throw console.error("Failed to import settings:",a),new g.PO("Failed to import settings")}}async clearSensitiveData(){this.settings.llmProviders=this.settings.llmProviders.map(a=>({...a,apiKey:"",apiKeyHash:""})),await this.saveSettings()}getStatistics(){let a=this.settings.llmProviders.filter(a=>a.apiKey).length,b=this.settings.mcpServers.filter(a=>a.enabled).length;return{totalProviders:this.settings.llmProviders.length,providersWithKeys:a,totalMcpServers:this.settings.mcpServers.length,enabledMcpServers:b,lastUpdated:new Date().toISOString()}}getDefaultSettings(){return{llmProviders:[{id:"openai-1",name:"openai",apiKey:"",baseUrl:"https://api.openai.com/v1",models:[{id:"gpt-4",name:"GPT-4",supportsToolCalling:!0,maxTokens:8192},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",supportsToolCalling:!0,maxTokens:4096}]},{id:"deepseek-1",name:"deepseek",apiKey:"",baseUrl:"https://api.deepseek.com/v1",models:[{id:"deepseek-chat",name:"DeepSeek Chat",supportsToolCalling:!0,maxTokens:4096}]},{id:"openrouter-1",name:"openrouter",apiKey:"",baseUrl:"https://openrouter.ai/api/v1",models:[{id:"openai/gpt-4",name:"GPT-4 (OpenRouter)",supportsToolCalling:!0,maxTokens:8192}]}],mcpServers:[{id:"filesystem-1",name:"filesystem",command:"npx",args:["-y","@modelcontextprotocol/server-filesystem","/tmp"],enabled:!1,status:"disconnected"}],preferences:{theme:"system",language:"en",autoScroll:!0,soundEnabled:!1}}}async ensureSettingsDirectory(){try{await d.promises.mkdir(this.settingsDir,{recursive:!0})}catch(a){throw new g.PO(`Failed to create settings directory: ${a}`)}}async loadSettings(){try{let a=await d.promises.readFile(this.settingsFile,"utf-8"),b=JSON.parse(a);this.settings={...this.getDefaultSettings(),...b}}catch(a){if("ENOENT"===a.code)this.settings=this.getDefaultSettings(),await this.saveSettings();else throw console.error("Failed to load settings:",a),new g.PO("Failed to load settings data")}}async saveSettings(){try{let a=JSON.stringify(this.settings,null,2);await d.promises.writeFile(this.settingsFile,a,"utf-8")}catch(a){throw console.error("Failed to save settings:",a),new g.PO("Failed to save settings data")}}sanitizeEnvironmentVariables(a){let b={},c=["api_key","secret","token","password","key"];for(let[d,e]of Object.entries(a)){let a=d.toLowerCase();c.some(b=>a.includes(b))?b[d]="[REDACTED]":b[d]=e}return b}}let i=null;function j(){return i||(i=new h),i}},3033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3873:a=>{"use strict";a.exports=require("path")},4870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:a=>{"use strict";a.exports=require("crypto")},6439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},6487:()=>{},8335:()=>{},9021:a=>{"use strict";a.exports=require("fs")},9294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9741:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>H,patchFetch:()=>G,routeModule:()=>C,serverHooks:()=>F,workAsyncStorage:()=>D,workUnitAsyncStorage:()=>E});var d={};c.r(d),c.d(d,{DELETE:()=>B,GET:()=>z,POST:()=>A,runtime:()=>y});var e=c(6559),f=c(8088),g=c(7719),h=c(6191),i=c(1289),j=c(261),k=c(2603),l=c(9893),m=c(4823),n=c(7220),o=c(6946),p=c(7912),q=c(9786),r=c(6143),s=c(6439),t=c(5746),u=c(2190),v=c(1986),w=c(9985);function x(a,b,c=1e3){if(a.length>c)throw new w.yI(`${b} exceeds maximum length of ${c} characters`)}let y="nodejs";async function z(){try{let a=(0,v.cQ)();await a.initialize();let b=await a.getSettings();return u.NextResponse.json({success:!0,data:b})}catch(a){if(console.error("Failed to get settings:",a),a instanceof w.yI)return u.NextResponse.json({success:!1,error:a.message},{status:400});return u.NextResponse.json({success:!1,error:"Failed to retrieve settings"},{status:500})}}async function A(a){try{let b=await a.json(),c=function(a){if(!a||"object"!=typeof a)throw new w.yI("Settings must be a valid JSON object");if(a.llmProviders){if(!Array.isArray(a.llmProviders))throw new w.yI("LLM providers must be an array");a.llmProviders.forEach((a,b)=>{if(!a||"object"!=typeof a)throw new w.yI(`LLM provider at index ${b} must be a valid object`);if(!a.id||"string"!=typeof a.id)throw new w.yI(`LLM provider at index ${b} must have a valid id`);if(!/^[a-zA-Z0-9_-]+$/.test(a.id))throw new w.yI(`LLM provider at index ${b} has invalid ID format`);if(!a.name||!["openai","deepseek","openrouter"].includes(a.name))throw new w.yI(`LLM provider at index ${b} must have a valid name`);if(!a.apiKey||"string"!=typeof a.apiKey||""===a.apiKey.trim()||a.apiKey.includes("*")||a.apiKey.includes("•")||function(a,b){if(!a||"string"!=typeof a)throw new w.yI("API key must be a valid string");if(a.length<10)throw new w.yI("API key is too short");if(a.length>200)throw new w.yI("API key is too long");switch(b){case"openai":if(!a.startsWith("sk-"))throw new w.yI('OpenAI API key must start with "sk-"');break;case"deepseek":if(!a.startsWith("sk-"))throw new w.yI('DeepSeek API key must start with "sk-"');break;case"openrouter":if(!a.startsWith("sk-or-"))throw new w.yI('OpenRouter API key must start with "sk-or-"')}for(let b of[/\s/,/[<>]/,/javascript:/i,/data:/i])if(b.test(a))throw new w.yI("API key contains invalid characters")}(a.apiKey,a.name),a.baseUrl&&"string"==typeof a.baseUrl&&!function(a){try{let b=new URL(a);return["http:","https:"].includes(b.protocol)}catch{return!1}}(a.baseUrl))throw new w.yI(`LLM provider at index ${b} has invalid base URL`)})}if(a.mcpServers){if(!Array.isArray(a.mcpServers))throw new w.yI("MCP servers must be an array");a.mcpServers.forEach((a,b)=>{try{var c=a;if(!c||"object"!=typeof c)throw new w.yI("MCP server config must be a valid object");if(!c.id||"string"!=typeof c.id)throw new w.yI("MCP server config must have a valid id");if(!/^[a-zA-Z0-9_-]+$/.test(c.id))throw new w.yI("MCP server config ID has invalid format");if(!c.name||"string"!=typeof c.name)throw new w.yI("MCP server config must have a valid name");if(x(c.name,"MCP server name",100),!c.command||"string"!=typeof c.command)throw new w.yI("MCP server config must have a valid command");if(!/^[a-zA-Z0-9_./\-]+$/.test(c.command))throw new w.yI("MCP server command contains invalid characters");if(!Array.isArray(c.args))throw new w.yI("MCP server args must be an array");c.args.forEach((a,b)=>{if("string"!=typeof a)throw new w.yI(`MCP server arg at index ${b} must be a string`);x(a,`MCP server arg ${b}`,500)}),c.env&&"object"==typeof c.env&&Object.entries(c.env).forEach(([a,b])=>{if("string"!=typeof a||"string"!=typeof b)throw new w.yI("MCP server environment variables must be strings");if(!/^[A-Z_][A-Z0-9_]*$/.test(a))throw new w.yI(`Invalid environment variable name: ${a}`);x(a,"Environment variable name",100),x(b,"Environment variable value",1e3)})}catch(c){let a=c instanceof Error?c.message:"Unknown error";throw new w.yI(`MCP server at index ${b}: ${a}`)}})}if(a.preferences)try{var b=a.preferences;if(!b||"object"!=typeof b)throw new w.yI("User preferences must be a valid object");if(b.theme&&!["light","dark","system"].includes(b.theme))throw new w.yI("Theme must be one of: light, dark, system");if(b.language&&!["en","zh"].includes(b.language))throw new w.yI("Language must be one of: en, zh");if(void 0!==b.autoScroll&&"boolean"!=typeof b.autoScroll)throw new w.yI("autoScroll must be a boolean");if(void 0!==b.soundEnabled&&"boolean"!=typeof b.soundEnabled)throw new w.yI("soundEnabled must be a boolean")}catch(b){let a=b instanceof Error?b.message:"Unknown error";throw new w.yI(`User preferences: ${a}`)}return a}(b),d=(0,v.cQ)();await d.initialize();let e=await d.updateSettings(c);return u.NextResponse.json({success:!0,data:e,message:"Settings updated successfully"})}catch(a){if(console.error("Failed to update settings:",a),a instanceof w.yI)return u.NextResponse.json({success:!1,error:a.message},{status:400});if(a instanceof w.PO)return u.NextResponse.json({success:!1,error:a.message},{status:a.statusCode});return u.NextResponse.json({success:!1,error:"Failed to update settings"},{status:500})}}async function B(){try{let a=(0,v.cQ)();return await a.initialize(),await a.clearSensitiveData(),u.NextResponse.json({success:!0,message:"Sensitive data cleared successfully"})}catch(a){return console.error("Failed to clear sensitive data:",a),u.NextResponse.json({success:!1,error:"Failed to clear sensitive data"},{status:500})}}let C=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/settings/route",pathname:"/api/settings",filename:"route",bundlePath:"app/api/settings/route"},distDir:".next",projectDir:"",resolvedPagePath:"/Users/onebird/github/mcp-chat-client/app/api/settings/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:D,workUnitAsyncStorage:E,serverHooks:F}=C;function G(){return(0,g.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:E})}async function H(a,b,c){var d;let e="/api/settings/route";"/index"===e&&(e="/");let g=await C.prepare(a,b,{srcPage:e,multiZoneDraftMode:"false"});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[D]);if(F&&!x){let a=!!y.routes[D],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||C.isDev||x||(G="/index"===(G=D)?"/":G);let H=!0===C.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{dynamicIO:!!w.experimental.dynamicIO,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>C.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>C.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await C.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await C.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(L||b instanceof s.NoFallbackError||await C.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},9985:(a,b,c)=>{"use strict";c.d(b,{PO:()=>g,m_:()=>f,yI:()=>e}),c(2190);class d extends Error{constructor(a,b=500,c=!0){super(a),this.statusCode=b,this.isOperational=c,Error.captureStackTrace(this,this.constructor)}}class e extends d{constructor(a){super(a,400)}}class f extends d{constructor(a="Resource not found"){super(a,404)}}class g extends d{constructor(a="Internal server error"){super(a,500)}}}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[985,55,690],()=>b(b.s=9741));module.exports=c})();