exports.id=685,exports.ids=[685],exports.modules={50241:(a,b,c)=>{"use strict";c.d(b,{jj:()=>j,Hz:()=>d.getMCPClientManager});var d=c(26761),e=c(31630),f=c(81986),g=c(79985);class h{constructor(){this.clients=new Map,this.settingsManager=(0,f.cQ)()}async initialize(){await this.settingsManager.initialize(),await this.refreshClients()}async chat(a,b){try{let c,d=await this.getClient(a);if(!await this.getProviderConfig(a))throw new g.yI(`Provider not found: ${a}`);let e=this.convertMessagesToOpenAI(b.messages),f={model:b.model,messages:e,temperature:b.temperature??.7,max_tokens:b.maxTokens,tools:b.tools,stream:!1};Date.now();let h=await d.chat.completions.create(f);Date.now();let i=h.choices[0],j=h.usage?{promptTokens:h.usage.prompt_tokens,completionTokens:h.usage.completion_tokens,totalTokens:h.usage.total_tokens}:void 0;return i.message.tool_calls&&(c=i.message.tool_calls.map(a=>({id:a.id,type:"function",function:{name:a.function.name,arguments:a.function.arguments},serverId:this.extractServerIdFromToolName(a.function.name)}))),{content:i.message.content||void 0,toolCalls:c,usage:j,finishReason:i.finish_reason||void 0,model:h.model}}catch(b){throw console.error(`LLM chat error for provider ${a}:`,b),this.handleLLMError(b,a)}}async *chatStream(a,b){try{let c,d=await this.getClient(a);if(!await this.getProviderConfig(a))throw new g.yI(`Provider not found: ${a}`);let e=this.convertMessagesToOpenAI(b.messages),f={model:b.model,messages:e,temperature:b.temperature??.7,max_tokens:b.maxTokens,tools:b.tools,stream:!0},h=await d.chat.completions.create(f),i=[];for await(let a of h){let b,d,e=a.choices[0];if(!e)continue;let f=e.delta;if(f.content&&(f.content,b=f.content),f.tool_calls){for(let a of f.tool_calls){let b=a.index||0;i[b]||(i[b]={id:a.id||"",type:"function",function:{name:"",arguments:""},serverId:""}),a.id&&(i[b].id=a.id),a.function?.name&&(i[b].function.name=a.function.name,i[b].serverId=this.extractServerIdFromToolName(a.function.name)),a.function?.arguments&&(i[b].function.arguments+=a.function.arguments)}d=[...i]}a.usage&&(c={promptTokens:a.usage.prompt_tokens,completionTokens:a.usage.completion_tokens,totalTokens:a.usage.total_tokens});let g=null!==e.finish_reason;if(yield{content:b,toolCalls:d,usage:c,finishReason:e.finish_reason||void 0,done:g},g)break}}catch(b){throw console.error(`LLM streaming error for provider ${a}:`,b),this.handleLLMError(b,a)}}async testConnection(a){try{let b,c=await this.getClient(a);await c.chat.completions.create({model:"gpt-3.5-turbo",messages:[{role:"user",content:"Hello"}],max_tokens:5});try{b=(await c.models.list()).data.filter(a=>a.id.includes("gpt")||a.id.includes("chat")).map(a=>({id:a.id,name:a.id,displayName:a.id,supportsToolCalling:this.modelSupportsToolCalling(a.id),maxTokens:this.getModelMaxTokens(a.id)}))}catch(b){console.warn(`Could not fetch models for ${a}:`,b)}return{success:!0,models:b}}catch(b){return console.error(`Connection test failed for provider ${a}:`,b),{success:!1,error:this.getErrorMessage(b)}}}async getAvailableModels(a){let b=await this.getProviderConfig(a);if(!b)throw new g.yI(`Provider not found: ${a}`);return b.models}async getProviderCapabilities(a){let b=await this.getProviderConfig(a);if(!b)throw new g.yI(`Provider not found: ${a}`);let c=b.name;return{supportsStreaming:!0,supportsToolCalling:!0,maxTokens:this.getProviderMaxTokens(c),supportedModels:b.models.map(a=>a.id)}}estimateCost(a,b,c){let d=this.getModelPricing(a,b),e=c.promptTokens/1e3*d.inputPer1k,f=c.completionTokens/1e3*d.outputPer1k;return{inputTokens:c.promptTokens,outputTokens:c.completionTokens,inputCost:e,outputCost:f,totalCost:e+f,currency:"USD"}}async refreshClients(){this.clients.clear()}async getClient(a){if(this.clients.has(a))return this.clients.get(a);let b=await this.getProviderConfig(a);if(!b)throw new g.yI(`Provider configuration not found: ${a}`);let c=await this.settingsManager.getDecryptedApiKey(a);if(!c)throw new g.yI(`API key not configured for provider: ${a}`);let d=new e.Ay({apiKey:c,baseURL:b.baseUrl});return this.clients.set(a,d),d}async getProviderConfig(a){return(await this.settingsManager.getSettings()).llmProviders.find(b=>b.id===a)}convertMessagesToOpenAI(a){return a.map(a=>{switch(a.role){case"user":default:return{role:"user",content:a.content};case"assistant":let b={role:"assistant",content:a.content};return a.toolCalls&&(b.tool_calls=a.toolCalls.map(a=>({id:a.id,type:"function",function:{name:a.function.name,arguments:a.function.arguments}}))),b;case"tool":return{role:"tool",content:a.content,tool_call_id:a.toolCallId||""};case"system":return{role:"system",content:a.content}}})}extractServerIdFromToolName(a){let b=a.split(".");return b.length>1?b[0]:""}handleLLMError(a,b){if(a instanceof g.yI||a instanceof g.PO)return a;if(a instanceof e.Ay.APIError)return 401===a.status?new g.yI(`Invalid API key for provider: ${b}`):429===a.status?new g.yI(`Rate limit exceeded for provider: ${b}`):400===a.status?new g.yI(`Invalid request to provider ${b}: ${a.message}`):new g.PO(`LLM API error for ${b}: ${a.message}`);return new g.PO(a instanceof Error?`LLM service error for ${b}: ${a.message}`:`Unknown LLM error for provider: ${b}`)}getErrorMessage(a){return a instanceof e.Ay.APIError?a.message||"API Error":a instanceof Error||a&&"object"==typeof a&&a.message?a.message:"Unknown error occurred"}modelSupportsToolCalling(a){return["gpt-4","gpt-4-turbo","gpt-4o","gpt-3.5-turbo","deepseek-chat","deepseek-coder"].some(b=>a.includes(b))}getModelMaxTokens(a){return a.includes("gpt-4")?8192:(a.includes("gpt-3.5")||a.includes("deepseek"),4096)}getProviderMaxTokens(a){switch(a){case"openai":case"openrouter":return 128e3;case"deepseek":return 32768;default:return 4096}}getModelPricing(a,b){for(let[a,c]of Object.entries({"gpt-4":{inputPer1k:.03,outputPer1k:.06},"gpt-4-turbo":{inputPer1k:.01,outputPer1k:.03},"gpt-3.5-turbo":{inputPer1k:.001,outputPer1k:.002},"deepseek-chat":{inputPer1k:.0014,outputPer1k:.0028},"deepseek-coder":{inputPer1k:.0014,outputPer1k:.0028}}))if(b.includes(a))return c;return{inputPer1k:.001,outputPer1k:.002}}}let i=null;function j(){return i||(i=new h),i}c(29021),c(33873)},78335:()=>{},79985:(a,b,c)=>{"use strict";c.d(b,{PO:()=>g,m_:()=>f,yI:()=>e}),c(32190);class d extends Error{constructor(a,b=500,c=!0){super(a),this.statusCode=b,this.isOperational=c,Error.captureStackTrace(this,this.constructor)}}class e extends d{constructor(a){super(a,400)}}class f extends d{constructor(a="Resource not found"){super(a,404)}}class g extends d{constructor(a="Internal server error"){super(a,500)}}},81986:(a,b,c)=>{"use strict";c.d(b,{cQ:()=>j});var d=c(29021),e=c(33873),f=c(91291),g=c(79985);class h{constructor(a="./data/settings"){this.encryptionService=(0,f.J)(),this.settingsDir=a,this.settingsFile=e.join(a,"settings.json"),this.settings=this.getDefaultSettings()}async initialize(){try{await this.ensureSettingsDirectory(),await this.loadSettings()}catch(a){throw console.error("Failed to initialize SecureSettingsManager:",a),new g.PO("Failed to initialize settings storage")}}async getSettings(){let a={...this.settings};return a.llmProviders=a.llmProviders.map(a=>({...a,apiKey:this.encryptionService.maskApiKey(a.apiKey?this.encryptionService.decrypt(a.apiKey):"")})),a}async updateSettings(a){try{if(a.llmProviders){let b=[];for(let c of a.llmProviders){let a=this.settings.llmProviders.find(a=>a.id===c.id),d="",e="";c.apiKey&&(c.apiKey.includes("*")||c.apiKey.includes("•")?a&&(d=a.apiKey,e=a.apiKeyHash||""):(d=this.encryptionService.encrypt(c.apiKey),e=this.encryptionService.hash(c.apiKey))),b.push({...c,apiKey:d,apiKeyHash:e})}this.settings.llmProviders=b}return a.mcpServers&&(this.settings.mcpServers=a.mcpServers),a.preferences&&(this.settings.preferences={...this.settings.preferences,...a.preferences}),await this.saveSettings(),this.getSettings()}catch(a){throw console.error("Failed to update settings:",a),new g.PO("Failed to update settings")}}async getDecryptedApiKey(a){let b=this.settings.llmProviders.find(b=>b.id===a);if(!b||!b.apiKey)throw new g.yI(`API key not found for provider: ${a}`);try{return this.encryptionService.decrypt(b.apiKey)}catch(b){throw console.error(`Failed to decrypt API key for provider ${a}:`,b),new g.PO("Failed to decrypt API key")}}async validateApiKey(a,b,c){if(!b||b.length<10)return!1;switch(a){case"openai":case"deepseek":return b.startsWith("sk-")&&b.length>20;case"openrouter":return b.startsWith("sk-or-")&&b.length>30;default:return b.length>10}}async exportSettings(){return{version:"1.0.0",exportDate:new Date().toISOString(),settings:{preferences:this.settings.preferences,mcpServers:this.settings.mcpServers.map(a=>({...a,env:a.env?this.sanitizeEnvironmentVariables(a.env):void 0}))}}}async importSettings(a){try{if("1.0.0"!==a.version)throw new g.yI("Unsupported settings export version");await this.updateSettings({preferences:a.settings.preferences,mcpServers:a.settings.mcpServers})}catch(a){throw console.error("Failed to import settings:",a),new g.PO("Failed to import settings")}}async clearSensitiveData(){this.settings.llmProviders=this.settings.llmProviders.map(a=>({...a,apiKey:"",apiKeyHash:""})),await this.saveSettings()}getStatistics(){let a=this.settings.llmProviders.filter(a=>a.apiKey).length,b=this.settings.mcpServers.filter(a=>a.enabled).length;return{totalProviders:this.settings.llmProviders.length,providersWithKeys:a,totalMcpServers:this.settings.mcpServers.length,enabledMcpServers:b,lastUpdated:new Date().toISOString()}}getDefaultSettings(){return{llmProviders:[{id:"openai-1",name:"openai",apiKey:"",baseUrl:"https://api.openai.com/v1",models:[{id:"gpt-4",name:"GPT-4",supportsToolCalling:!0,maxTokens:8192},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",supportsToolCalling:!0,maxTokens:4096}]},{id:"deepseek-1",name:"deepseek",apiKey:"",baseUrl:"https://api.deepseek.com/v1",models:[{id:"deepseek-chat",name:"DeepSeek Chat",supportsToolCalling:!0,maxTokens:4096}]},{id:"openrouter-1",name:"openrouter",apiKey:"",baseUrl:"https://openrouter.ai/api/v1",models:[{id:"openai/gpt-4",name:"GPT-4 (OpenRouter)",supportsToolCalling:!0,maxTokens:8192}]}],mcpServers:[{id:"filesystem-1",name:"filesystem",command:"npx",args:["-y","@modelcontextprotocol/server-filesystem","/tmp"],enabled:!1,status:"disconnected"}],preferences:{theme:"system",language:"en",autoScroll:!0,soundEnabled:!1}}}async ensureSettingsDirectory(){try{await d.promises.mkdir(this.settingsDir,{recursive:!0})}catch(a){throw new g.PO(`Failed to create settings directory: ${a}`)}}async loadSettings(){try{let a=await d.promises.readFile(this.settingsFile,"utf-8"),b=JSON.parse(a);this.settings={...this.getDefaultSettings(),...b}}catch(a){if("ENOENT"===a.code)this.settings=this.getDefaultSettings(),await this.saveSettings();else throw console.error("Failed to load settings:",a),new g.PO("Failed to load settings data")}}async saveSettings(){try{let a=JSON.stringify(this.settings,null,2);await d.promises.writeFile(this.settingsFile,a,"utf-8")}catch(a){throw console.error("Failed to save settings:",a),new g.PO("Failed to save settings data")}}sanitizeEnvironmentVariables(a){let b={},c=["api_key","secret","token","password","key"];for(let[d,e]of Object.entries(a)){let a=d.toLowerCase();c.some(b=>a.includes(b))?b[d]="[REDACTED]":b[d]=e}return b}}let i=null;function j(){return i||(i=new h),i}},91291:(a,b,c)=>{"use strict";c.d(b,{J:()=>h});var d=c(46690),e=c(79985);class f{constructor(){this.secretKey=process.env.ENCRYPTION_KEY||this.generateDefaultKey(),process.env.ENCRYPTION_KEY||console.warn("ENCRYPTION_KEY not set in environment. Using generated key. This is not secure for production!")}encrypt(a){try{if(!a)return"";return d.AES.encrypt(a,this.secretKey).toString()}catch(a){throw console.error("Encryption failed:",a),new e.PO("Failed to encrypt data")}}decrypt(a){try{if(!a)return"";let b=d.AES.decrypt(a,this.secretKey).toString(d.enc.Utf8);if(!b)throw Error("Failed to decrypt data - invalid key or corrupted data");return b}catch(a){throw console.error("Decryption failed:",a),new e.PO("Failed to decrypt data")}}hash(a){try{return d.SHA256(a).toString()}catch(a){throw console.error("Hashing failed:",a),new e.PO("Failed to hash data")}}generateSecureKey(){return d.lib.WordArray.random(32).toString()}maskApiKey(a){if(!a||a.length<8)return"••••";let b=Math.min(8,Math.max(0,a.length-4));return"•".repeat(b)+a.slice(-4)}isEncrypted(a){try{return this.decrypt(a),!0}catch{return!1}}generateDefaultKey(){let a=process.platform+process.arch+(process.env.HOME||process.env.USERPROFILE||"default");return d.SHA256(a+"mcp-chat-ui-default-key").toString()}}let g=null;function h(){return g||(g=new f),g}},96487:()=>{}};