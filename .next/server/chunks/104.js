exports.id=104,exports.ids=[104],exports.modules={11948:(a,b,c)=>{"use strict";c.d(b,{jj:()=>o,Hz:()=>i});var d=c(3348),e=c(47971),f=c(64077);class g{constructor(a={}){this.connections=new Map,this.reconnectTimers=new Map,this.toolCache=new Map,this.isShuttingDown=!1,this.options={maxReconnectAttempts:a.maxReconnectAttempts??5,reconnectDelay:a.reconnectDelay??2e3,connectionTimeout:a.connectionTimeout??15e3,healthCheckInterval:a.healthCheckInterval??3e4,toolCacheTimeout:a.toolCacheTimeout??6e4},this.startHealthMonitoring(),f.EZ.addWatcher(()=>{this.handleConfigurationChange()})}async initialize(){console.log("Initializing MCP Client Manager...");try{let a=await f.EZ.getConfig(),b=Object.entries(a.mcpServers).map(([a,b])=>({id:a,name:a,command:b.command,args:b.args||[],env:b.env||{},enabled:!b.disabled,timeout:b.timeout,maxConcurrency:b.maxConcurrency}));await this.updateServerConfigs(b),console.log(`MCP Client Manager initialized with ${b.length} server configurations`)}catch(a){throw console.error("Failed to initialize MCP Client Manager:",a),a}}async connectServer(a){if(!a.enabled)return void console.log(`Server ${a.name} is disabled, skipping connection`);let b=this.connections.get(a.id);if(b?.status==="connected")return void console.log(`Server ${a.name} is already connected`);console.log(`Connecting to MCP server: ${a.name} (${a.command} ${a.args?.join(" ")})`);let c={id:a.id,client:null,transport:null,config:{...a,status:"connecting"},tools:[],status:"connecting",reconnectAttempts:b?.reconnectAttempts||0,connectionStartTime:new Date};this.connections.set(a.id,c);try{let b=new d.oQ({command:a.command,args:a.args||[],env:{...process.env,...a.env}}),f=new e.K({name:"mcp-chat-ui",version:"1.0.0"},{capabilities:{tools:{},resources:{},prompts:{}}}),g=new Promise((a,b)=>{setTimeout(()=>{b(Error(`Connection timeout after ${this.options.connectionTimeout}ms`))},this.options.connectionTimeout)});await Promise.race([f.connect(b),g]);let h=await this.discoverTools(f,a.id),i={id:a.id,client:f,transport:b,config:{...a,status:"connected"},tools:h,status:"connected",reconnectAttempts:0,lastError:void 0,lastHealthCheck:new Date,connectionStartTime:c.connectionStartTime};this.connections.set(a.id,i),this.toolCache.set(a.id,{tools:h,timestamp:new Date}),console.log(`Successfully connected to ${a.name} with ${h.length} tools`),this.setupConnectionErrorHandling(i)}catch(e){let b=e instanceof Error?e.message:"Unknown error";console.error(`Failed to connect to ${a.name}:`,b);let d={id:a.id,client:null,transport:null,config:{...a,status:"error"},tools:[],status:"error",lastError:b,reconnectAttempts:c.reconnectAttempts,connectionStartTime:c.connectionStartTime};this.connections.set(a.id,d),a.enabled&&!this.isShuttingDown&&this.scheduleReconnection(a.id)}}async disconnectServer(a){let b=this.connections.get(a);if(!b)return void console.log(`Server ${a} not found`);console.log(`Disconnecting from MCP server: ${b.config.name}`);let c=this.reconnectTimers.get(a);c&&(clearTimeout(c),this.reconnectTimers.delete(a));try{b.client&&"connected"===b.status&&await b.client.close(),b.process&&!b.process.killed&&b.process.kill("SIGTERM")}catch(a){console.error(`Error closing connection to ${b.config.name}:`,a)}b.status="disconnected",b.config.status="disconnected",b.tools=[],b.lastError=void 0,this.toolCache.delete(a),console.log(`Disconnected from ${b.config.name}`)}async reconnectServer(a){let b=this.connections.get(a);if(!b)throw Error(`Server ${a} not found`);console.log(`Reconnecting to MCP server: ${b.config.name}`),await this.disconnectServer(a),b.reconnectAttempts=0,await this.connectServer(b.config)}async discoverTools(a,b){try{let c=(await a.listTools()).tools.map(a=>({name:`${b}.${a.name}`,description:a.description||"",inputSchema:a.inputSchema,serverId:b,category:this.categorizeToolByName(a.name),dangerous:this.isToolDangerous(a.name,a.description),requiresConfirmation:!0}));return console.log(`Discovered ${c.length} tools from ${b}:`,c.map(a=>a.name)),c}catch(a){return console.error(`Failed to discover tools from ${b}:`,a),[]}}getAllTools(){let a=[];for(let b of this.connections.values())if("connected"===b.status){let c=this.toolCache.get(b.id);c&&this.isCacheValid(c.timestamp)?a.push(...c.tools):a.push(...b.tools)}return a}getServerTools(a){let b=this.connections.get(a);if(!b||"connected"!==b.status)return[];let c=this.toolCache.get(a);return c&&this.isCacheValid(c.timestamp)?c.tools:b.tools}async executeTool(a,b){let c=Date.now(),[d,e]=this.parseToolName(a);if(!d||!e)return{success:!1,error:`Invalid tool name format: ${a}. Expected format: serverId.toolName`,executionTime:Date.now()-c,serverId:d||"unknown",toolName:e||a};let f=this.connections.get(d);if(!f)return{success:!1,error:`Server "${d}" not found`,executionTime:Date.now()-c,serverId:d,toolName:e};if("connected"!==f.status)return{success:!1,error:`Server "${d}" is not connected (status: ${f.status})`,executionTime:Date.now()-c,serverId:d,toolName:e};console.log(`Executing tool "${e}" on server ${d} with parameters:`,b);try{let a=new Promise((a,b)=>{setTimeout(()=>{b(Error(`Tool execution timeout after ${f.config.timeout||3e4}ms`))},f.config.timeout||3e4)}),g=await Promise.race([f.client.callTool({name:e,arguments:b}),a]),h=Date.now()-c;return console.log(`Tool "${e}" executed successfully in ${h}ms`),{success:!0,result:g,executionTime:h,serverId:d,toolName:e}}catch(f){let a=Date.now()-c,b=f instanceof Error?f.message:"Unknown error";return console.error(`Tool execution failed for "${e}" on ${d}:`,b),this.isConnectionError(f)&&(console.log(`Connection error detected, scheduling reconnection for ${d}`),this.scheduleReconnection(d)),{success:!1,error:b,executionTime:a,serverId:d,toolName:e}}}getConnectionStatuses(){let a={};for(let[b,c]of this.connections.entries()){let d=c.connectionStartTime?Date.now()-c.connectionStartTime.getTime():void 0;a[b]={serverId:b,status:this.getHealthStatus(c),lastCheck:c.lastHealthCheck||new Date,error:c.lastError,toolCount:c.tools.length,uptime:d}}return a}async updateServerConfigs(a){console.log(`Updating server configurations for ${a.length} servers`);let b=new Map(a.map(a=>[a.id,a]));for(let[a,c]of this.connections.entries()){let c=b.get(a);c&&c.enabled||(await this.disconnectServer(a),c||this.connections.delete(a))}let c=a.filter(a=>a.enabled).map(async a=>{let b=this.connections.get(a.id);b?this.hasConfigChanged(b.config,a)&&(console.log(`Configuration changed for ${a.name}, reconnecting...`),await this.reconnectServer(a.id)):await this.connectServer(a)});await Promise.allSettled(c)}async performHealthCheck(){if(this.isShuttingDown)return;let a=Array.from(this.connections.values()).filter(a=>"connected"===a.status).map(async a=>{try{let b=Date.now();await a.client.listTools();let c=Date.now()-b;if(a.lastHealthCheck=new Date,!this.isCacheValid(this.toolCache.get(a.id)?.timestamp)){let b=await this.discoverTools(a.client,a.id);a.tools=b,this.toolCache.set(a.id,{tools:b,timestamp:new Date})}console.log(`Health check passed for ${a.config.name} (${c}ms)`)}catch(b){console.error(`Health check failed for ${a.config.name}:`,b),this.isConnectionError(b)&&(a.status="error",a.lastError=b instanceof Error?b.message:"Health check failed",this.scheduleReconnection(a.id))}});await Promise.allSettled(a)}async shutdown(){for(let a of(console.log("Shutting down MCP Client Manager..."),this.isShuttingDown=!0,this.healthCheckTimer&&(clearTimeout(this.healthCheckTimer),this.healthCheckTimer=void 0),this.reconnectTimers.values()))clearTimeout(a);this.reconnectTimers.clear();let a=Array.from(this.connections.keys()).map(a=>this.disconnectServer(a));await Promise.allSettled(a),this.connections.clear(),this.toolCache.clear(),console.log("MCP Client Manager shutdown complete")}startHealthMonitoring(){let a=async()=>{try{await this.performHealthCheck()}catch(a){console.error("Health check error:",a)}finally{this.isShuttingDown||(this.healthCheckTimer=setTimeout(a,this.options.healthCheckInterval))}};this.healthCheckTimer=setTimeout(a,this.options.healthCheckInterval)}async handleConfigurationChange(){if(!this.isShuttingDown)try{console.log("Configuration changed, updating server connections...");let a=await f.EZ.getConfig(),b=Object.entries(a.mcpServers).map(([a,b])=>({id:a,name:a,command:b.command,args:b.args||[],env:b.env||{},enabled:!b.disabled,timeout:b.timeout,maxConcurrency:b.maxConcurrency}));await this.updateServerConfigs(b)}catch(a){console.error("Failed to handle configuration change:",a)}}setupConnectionErrorHandling(a){}scheduleReconnection(a){let b=this.connections.get(a);if(!b||!b.config.enabled||this.isShuttingDown)return;if(b.reconnectAttempts>=this.options.maxReconnectAttempts){console.log(`Max reconnection attempts (${this.options.maxReconnectAttempts}) reached for ${b.config.name}`),b.status="error",b.lastError="Max reconnection attempts exceeded";return}let c=this.reconnectTimers.get(a);c&&clearTimeout(c);let d=this.options.reconnectDelay*Math.pow(2,b.reconnectAttempts);console.log(`Scheduling reconnection for ${b.config.name} in ${d}ms (attempt ${b.reconnectAttempts+1}/${this.options.maxReconnectAttempts})`);let e=setTimeout(async()=>{if(!this.isShuttingDown){b.reconnectAttempts++,b.lastReconnectTime=new Date;try{await this.connectServer(b.config)}catch(c){console.error(`Reconnection failed for ${b.config.name}:`,c),b.reconnectAttempts<this.options.maxReconnectAttempts&&this.scheduleReconnection(a)}}},d);this.reconnectTimers.set(a,e)}parseToolName(a){let b=a.split(".");return b.length<2?[null,null]:[b[0],b.slice(1).join(".")]}isConnectionError(a){if(!a)return!1;let b=a.message?.toLowerCase()||"";return b.includes("connection")||b.includes("timeout")||b.includes("econnrefused")||b.includes("enotfound")||b.includes("closed")||b.includes("broken pipe")||b.includes("socket")}hasConfigChanged(a,b){return a.command!==b.command||JSON.stringify(a.args)!==JSON.stringify(b.args)||JSON.stringify(a.env)!==JSON.stringify(b.env)||a.enabled!==b.enabled||a.timeout!==b.timeout||a.maxConcurrency!==b.maxConcurrency}getHealthStatus(a){return"connected"!==a.status?"unhealthy":a.lastHealthCheck?Date.now()-a.lastHealthCheck.getTime()>2*this.options.healthCheckInterval?"unknown":"healthy":"unknown"}isCacheValid(a){return!!a&&Date.now()-a.getTime()<this.options.toolCacheTimeout}categorizeToolByName(a){let b=a.toLowerCase();return b.includes("file")||b.includes("read")||b.includes("write")?"filesystem":b.includes("web")||b.includes("http")||b.includes("url")?"web":b.includes("search")||b.includes("query")?"search":b.includes("git")||b.includes("repo")?"version-control":"general"}isToolDangerous(a,b){let c=`${a} ${b||""}`.toLowerCase();return["delete","remove","destroy","kill","terminate","format","wipe","clear","reset","drop","execute","run","shell","command","script"].some(a=>c.includes(a))}}let h=null;function i(){return h||(h=new g),h}var j=c(31630),k=c(81986),l=c(79985);class m{constructor(){this.clients=new Map,this.settingsManager=(0,k.cQ)()}async initialize(){await this.settingsManager.initialize(),await this.refreshClients()}async chat(a,b){try{let c,d=await this.getClient(a);if(!await this.getProviderConfig(a))throw new l.yI(`Provider not found: ${a}`);let e=this.convertMessagesToOpenAI(b.messages),f={model:b.model,messages:e,temperature:b.temperature??.7,max_tokens:b.maxTokens,tools:b.tools,stream:!1};Date.now();let g=await d.chat.completions.create(f);Date.now();let h=g.choices[0],i=g.usage?{promptTokens:g.usage.prompt_tokens,completionTokens:g.usage.completion_tokens,totalTokens:g.usage.total_tokens}:void 0;return h.message.tool_calls&&(c=h.message.tool_calls.map(a=>({id:a.id,type:"function",function:{name:a.function.name,arguments:a.function.arguments},serverId:this.extractServerIdFromToolName(a.function.name)}))),{content:h.message.content||void 0,toolCalls:c,usage:i,finishReason:h.finish_reason||void 0,model:g.model}}catch(b){throw console.error(`LLM chat error for provider ${a}:`,b),this.handleLLMError(b,a)}}async *chatStream(a,b){try{let c,d=await this.getClient(a);if(!await this.getProviderConfig(a))throw new l.yI(`Provider not found: ${a}`);let e=this.convertMessagesToOpenAI(b.messages),f={model:b.model,messages:e,temperature:b.temperature??.7,max_tokens:b.maxTokens,tools:b.tools,stream:!0},g=await d.chat.completions.create(f),h=[];for await(let a of g){let b,d,e=a.choices[0];if(!e)continue;let f=e.delta;if(f.content&&(f.content,b=f.content),f.tool_calls){for(let a of f.tool_calls){let b=a.index||0;h[b]||(h[b]={id:a.id||"",type:"function",function:{name:"",arguments:""},serverId:""}),a.id&&(h[b].id=a.id),a.function?.name&&(h[b].function.name=a.function.name,h[b].serverId=this.extractServerIdFromToolName(a.function.name)),a.function?.arguments&&(h[b].function.arguments+=a.function.arguments)}d=[...h]}a.usage&&(c={promptTokens:a.usage.prompt_tokens,completionTokens:a.usage.completion_tokens,totalTokens:a.usage.total_tokens});let g=null!==e.finish_reason;if(yield{content:b,toolCalls:d,usage:c,finishReason:e.finish_reason||void 0,done:g},g)break}}catch(b){throw console.error(`LLM streaming error for provider ${a}:`,b),this.handleLLMError(b,a)}}async testConnection(a){try{let b,c=await this.getClient(a);await c.chat.completions.create({model:"gpt-3.5-turbo",messages:[{role:"user",content:"Hello"}],max_tokens:5});try{b=(await c.models.list()).data.filter(a=>a.id.includes("gpt")||a.id.includes("chat")).map(a=>({id:a.id,name:a.id,displayName:a.id,supportsToolCalling:this.modelSupportsToolCalling(a.id),maxTokens:this.getModelMaxTokens(a.id)}))}catch(b){console.warn(`Could not fetch models for ${a}:`,b)}return{success:!0,models:b}}catch(b){return console.error(`Connection test failed for provider ${a}:`,b),{success:!1,error:this.getErrorMessage(b)}}}async getAvailableModels(a){let b=await this.getProviderConfig(a);if(!b)throw new l.yI(`Provider not found: ${a}`);return b.models}async getProviderCapabilities(a){let b=await this.getProviderConfig(a);if(!b)throw new l.yI(`Provider not found: ${a}`);let c=b.name;return{supportsStreaming:!0,supportsToolCalling:!0,maxTokens:this.getProviderMaxTokens(c),supportedModels:b.models.map(a=>a.id)}}estimateCost(a,b,c){let d=this.getModelPricing(a,b),e=c.promptTokens/1e3*d.inputPer1k,f=c.completionTokens/1e3*d.outputPer1k;return{inputTokens:c.promptTokens,outputTokens:c.completionTokens,inputCost:e,outputCost:f,totalCost:e+f,currency:"USD"}}async refreshClients(){this.clients.clear()}async getClient(a){if(this.clients.has(a))return this.clients.get(a);let b=await this.getProviderConfig(a);if(!b)throw new l.yI(`Provider configuration not found: ${a}`);let c=await this.settingsManager.getDecryptedApiKey(a);if(!c)throw new l.yI(`API key not configured for provider: ${a}`);let d=new j.Ay({apiKey:c,baseURL:b.baseUrl});return this.clients.set(a,d),d}async getProviderConfig(a){return(await this.settingsManager.getSettings()).llmProviders.find(b=>b.id===a)}convertMessagesToOpenAI(a){return a.map(a=>{switch(a.role){case"user":default:return{role:"user",content:a.content};case"assistant":let b={role:"assistant",content:a.content};return a.toolCalls&&(b.tool_calls=a.toolCalls.map(a=>({id:a.id,type:"function",function:{name:a.function.name,arguments:a.function.arguments}}))),b;case"tool":return{role:"tool",content:a.content,tool_call_id:a.toolCallId||""};case"system":return{role:"system",content:a.content}}})}extractServerIdFromToolName(a){let b=a.split(".");return b.length>1?b[0]:""}handleLLMError(a,b){if(a instanceof l.yI||a instanceof l.PO)return a;if(a instanceof j.Ay.APIError)return 401===a.status?new l.yI(`Invalid API key for provider: ${b}`):429===a.status?new l.yI(`Rate limit exceeded for provider: ${b}`):400===a.status?new l.yI(`Invalid request to provider ${b}: ${a.message}`):new l.PO(`LLM API error for ${b}: ${a.message}`);return new l.PO(a instanceof Error?`LLM service error for ${b}: ${a.message}`:`Unknown LLM error for provider: ${b}`)}getErrorMessage(a){return a instanceof j.Ay.APIError?a.message||"API Error":a instanceof Error||a&&"object"==typeof a&&a.message?a.message:"Unknown error occurred"}modelSupportsToolCalling(a){return["gpt-4","gpt-4-turbo","gpt-4o","gpt-3.5-turbo","deepseek-chat","deepseek-coder"].some(b=>a.includes(b))}getModelMaxTokens(a){return a.includes("gpt-4")?8192:(a.includes("gpt-3.5")||a.includes("deepseek"),4096)}getProviderMaxTokens(a){switch(a){case"openai":case"openrouter":return 128e3;case"deepseek":return 32768;default:return 4096}}getModelPricing(a,b){for(let[a,c]of Object.entries({"gpt-4":{inputPer1k:.03,outputPer1k:.06},"gpt-4-turbo":{inputPer1k:.01,outputPer1k:.03},"gpt-3.5-turbo":{inputPer1k:.001,outputPer1k:.002},"deepseek-chat":{inputPer1k:.0014,outputPer1k:.0028},"deepseek-coder":{inputPer1k:.0014,outputPer1k:.0028}}))if(b.includes(a))return c;return{inputPer1k:.001,outputPer1k:.002}}}let n=null;function o(){return n||(n=new m),n}c(29021),c(33873)},64077:(a,b,c)=>{"use strict";c.d(b,{EZ:()=>n});var d=c(72289),e=c(35282),f=c(79748),g=c.n(f),h=c(29021),i=c(33873),j=c.n(i);let k=d.Ik({command:d.Yj().min(1,"Command is required"),args:d.YO(d.Yj()).optional().default([]),env:d.g1(d.Yj(),d.Yj()).optional().default({}),disabled:d.zM().optional().default(!1),timeout:d.ai().positive().optional().default(3e4),maxConcurrency:d.ai().positive().optional().default(5)}),l=d.Ik({mcpServers:d.g1(d.Yj(),k)});class m{constructor(){this.config=null,this.watchers=new Set,this.fileWatcher=null,this.configPath=j().join(process.cwd(),"config","mcp.config.json")}static getInstance(){return m.instance||(m.instance=new m),m.instance}async loadConfig(){try{let a=await g().readFile(this.configPath,"utf-8"),b=JSON.parse(a),c=l.parse(b);return this.config=c,console.log(`MCP configuration loaded successfully from ${this.configPath}`),c}catch(a){if(a instanceof e.G)throw console.error("MCP configuration validation failed:",a.errors),Error(`Invalid MCP configuration: ${a.errors.map(a=>`${a.path.join(".")}: ${a.message}`).join(", ")}`);if("ENOENT"===a.code)throw console.error(`MCP configuration file not found: ${this.configPath}`),Error(`MCP configuration file not found: ${this.configPath}`);throw console.error("Failed to load MCP configuration:",a),Error(`Failed to load MCP configuration: ${a instanceof Error?a.message:"Unknown error"}`)}}async getConfig(){return this.config||await this.loadConfig(),this.config}async getServerConfig(a){return(await this.getConfig()).mcpServers[a]||null}async getEnabledServers(){let a=await this.getConfig(),b={};for(let[c,d]of Object.entries(a.mcpServers))d.disabled||(b[c]=d);return b}validateConfig(a){return l.parse(a)}async saveConfig(a){try{let b=l.parse(a),c=j().dirname(this.configPath);await g().mkdir(c,{recursive:!0}),await g().writeFile(this.configPath,JSON.stringify(b,null,2),"utf-8"),this.config=b,console.log(`MCP configuration saved to ${this.configPath}`),this.notifyWatchers()}catch(a){throw console.error("Failed to save MCP configuration:",a),Error(`Failed to save MCP configuration: ${a instanceof Error?a.message:"Unknown error"}`)}}startWatching(){if(!this.fileWatcher)try{this.fileWatcher=(0,h.watch)(this.configPath,{persistent:!1},async a=>{if("change"===a){console.log("MCP configuration file changed, reloading...");try{await this.loadConfig(),this.notifyWatchers()}catch(a){console.error("Failed to reload MCP configuration:",a)}}}),console.log(`Started watching MCP configuration file: ${this.configPath}`)}catch(a){console.error("Failed to start watching MCP configuration file:",a)}}stopWatching(){this.fileWatcher&&(this.fileWatcher.close(),this.fileWatcher=null,console.log("Stopped watching MCP configuration file"))}addWatcher(a){this.watchers.add(a)}removeWatcher(a){this.watchers.delete(a)}notifyWatchers(){for(let a of this.watchers)try{a()}catch(a){console.error("Error in MCP configuration watcher:",a)}}async reloadConfig(){return await this.loadConfig()}async configExists(){try{return await g().access(this.configPath),!0}catch{return!1}}async createDefaultConfig(){await this.configExists()||(await this.saveConfig({mcpServers:{filesystem:{command:"npx",args:["-y","@modelcontextprotocol/server-filesystem","/tmp"],env:{},disabled:!1,timeout:3e4,maxConcurrency:5}}}),console.log("Created default MCP configuration"))}}let n=m.getInstance()},78335:()=>{},79985:(a,b,c)=>{"use strict";c.d(b,{PO:()=>g,m_:()=>f,yI:()=>e}),c(32190);class d extends Error{constructor(a,b=500,c=!0){super(a),this.statusCode=b,this.isOperational=c,Error.captureStackTrace(this,this.constructor)}}class e extends d{constructor(a){super(a,400)}}class f extends d{constructor(a="Resource not found"){super(a,404)}}class g extends d{constructor(a="Internal server error"){super(a,500)}}},81986:(a,b,c)=>{"use strict";c.d(b,{cQ:()=>j});var d=c(29021),e=c(33873),f=c(91291),g=c(79985);class h{constructor(a="./data/settings"){this.encryptionService=(0,f.J)(),this.settingsDir=a,this.settingsFile=e.join(a,"settings.json"),this.settings=this.getDefaultSettings()}async initialize(){try{await this.ensureSettingsDirectory(),await this.loadSettings()}catch(a){throw console.error("Failed to initialize SecureSettingsManager:",a),new g.PO("Failed to initialize settings storage")}}async getSettings(){let a={...this.settings};return a.llmProviders=a.llmProviders.map(a=>({...a,apiKey:this.encryptionService.maskApiKey(a.apiKey?this.encryptionService.decrypt(a.apiKey):"")})),a}async updateSettings(a){try{if(a.llmProviders){let b=[];for(let c of a.llmProviders){let a=this.settings.llmProviders.find(a=>a.id===c.id),d="",e="";c.apiKey&&(c.apiKey.includes("*")||c.apiKey.includes("•")?a&&(d=a.apiKey,e=a.apiKeyHash||""):(d=this.encryptionService.encrypt(c.apiKey),e=this.encryptionService.hash(c.apiKey))),b.push({...c,apiKey:d,apiKeyHash:e})}this.settings.llmProviders=b}return a.mcpServers&&(this.settings.mcpServers=a.mcpServers),a.preferences&&(this.settings.preferences={...this.settings.preferences,...a.preferences}),await this.saveSettings(),this.getSettings()}catch(a){throw console.error("Failed to update settings:",a),new g.PO("Failed to update settings")}}async getDecryptedApiKey(a){let b=this.settings.llmProviders.find(b=>b.id===a);if(!b||!b.apiKey)throw new g.yI(`API key not found for provider: ${a}`);try{return this.encryptionService.decrypt(b.apiKey)}catch(b){throw console.error(`Failed to decrypt API key for provider ${a}:`,b),new g.PO("Failed to decrypt API key")}}async validateApiKey(a,b,c){if(!b||b.length<10)return!1;switch(a){case"openai":case"deepseek":return b.startsWith("sk-")&&b.length>20;case"openrouter":return b.startsWith("sk-or-")&&b.length>30;default:return b.length>10}}async exportSettings(){return{version:"1.0.0",exportDate:new Date().toISOString(),settings:{preferences:this.settings.preferences,mcpServers:this.settings.mcpServers.map(a=>({...a,env:a.env?this.sanitizeEnvironmentVariables(a.env):void 0}))}}}async importSettings(a){try{if("1.0.0"!==a.version)throw new g.yI("Unsupported settings export version");await this.updateSettings({preferences:a.settings.preferences,mcpServers:a.settings.mcpServers})}catch(a){throw console.error("Failed to import settings:",a),new g.PO("Failed to import settings")}}async clearSensitiveData(){this.settings.llmProviders=this.settings.llmProviders.map(a=>({...a,apiKey:"",apiKeyHash:""})),await this.saveSettings()}getStatistics(){let a=this.settings.llmProviders.filter(a=>a.apiKey).length,b=this.settings.mcpServers.filter(a=>a.enabled).length;return{totalProviders:this.settings.llmProviders.length,providersWithKeys:a,totalMcpServers:this.settings.mcpServers.length,enabledMcpServers:b,lastUpdated:new Date().toISOString()}}getDefaultSettings(){return{llmProviders:[{id:"openai-1",name:"openai",apiKey:"",baseUrl:"https://api.openai.com/v1",models:[{id:"gpt-4",name:"GPT-4",supportsToolCalling:!0,maxTokens:8192},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",supportsToolCalling:!0,maxTokens:4096}]},{id:"deepseek-1",name:"deepseek",apiKey:"",baseUrl:"https://api.deepseek.com/v1",models:[{id:"deepseek-chat",name:"DeepSeek Chat",supportsToolCalling:!0,maxTokens:4096}]},{id:"openrouter-1",name:"openrouter",apiKey:"",baseUrl:"https://openrouter.ai/api/v1",models:[{id:"openai/gpt-4",name:"GPT-4 (OpenRouter)",supportsToolCalling:!0,maxTokens:8192}]}],mcpServers:[{id:"filesystem-1",name:"filesystem",command:"npx",args:["-y","@modelcontextprotocol/server-filesystem","/tmp"],enabled:!1,status:"disconnected"}],preferences:{theme:"system",language:"en",autoScroll:!0,soundEnabled:!1}}}async ensureSettingsDirectory(){try{await d.promises.mkdir(this.settingsDir,{recursive:!0})}catch(a){throw new g.PO(`Failed to create settings directory: ${a}`)}}async loadSettings(){try{let a=await d.promises.readFile(this.settingsFile,"utf-8"),b=JSON.parse(a);this.settings={...this.getDefaultSettings(),...b}}catch(a){if("ENOENT"===a.code)this.settings=this.getDefaultSettings(),await this.saveSettings();else throw console.error("Failed to load settings:",a),new g.PO("Failed to load settings data")}}async saveSettings(){try{let a=JSON.stringify(this.settings,null,2);await d.promises.writeFile(this.settingsFile,a,"utf-8")}catch(a){throw console.error("Failed to save settings:",a),new g.PO("Failed to save settings data")}}sanitizeEnvironmentVariables(a){let b={},c=["api_key","secret","token","password","key"];for(let[d,e]of Object.entries(a)){let a=d.toLowerCase();c.some(b=>a.includes(b))?b[d]="[REDACTED]":b[d]=e}return b}}let i=null;function j(){return i||(i=new h),i}},91291:(a,b,c)=>{"use strict";c.d(b,{J:()=>h});var d=c(46690),e=c(79985);class f{constructor(){this.secretKey=process.env.ENCRYPTION_KEY||this.generateDefaultKey(),process.env.ENCRYPTION_KEY||console.warn("ENCRYPTION_KEY not set in environment. Using generated key. This is not secure for production!")}encrypt(a){try{if(!a)return"";return d.AES.encrypt(a,this.secretKey).toString()}catch(a){throw console.error("Encryption failed:",a),new e.PO("Failed to encrypt data")}}decrypt(a){try{if(!a)return"";let b=d.AES.decrypt(a,this.secretKey).toString(d.enc.Utf8);if(!b)throw Error("Failed to decrypt data - invalid key or corrupted data");return b}catch(a){throw console.error("Decryption failed:",a),new e.PO("Failed to decrypt data")}}hash(a){try{return d.SHA256(a).toString()}catch(a){throw console.error("Hashing failed:",a),new e.PO("Failed to hash data")}}generateSecureKey(){return d.lib.WordArray.random(32).toString()}maskApiKey(a){if(!a||a.length<8)return"••••";let b=Math.min(8,Math.max(0,a.length-4));return"•".repeat(b)+a.slice(-4)}isEncrypted(a){try{return this.decrypt(a),!0}catch{return!1}}generateDefaultKey(){let a=process.platform+process.arch+(process.env.HOME||process.env.USERPROFILE||"default");return d.SHA256(a+"mcp-chat-ui-default-key").toString()}}let g=null;function h(){return g||(g=new f),g}},96487:()=>{}};